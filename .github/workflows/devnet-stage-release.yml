<<<<<<< HEAD
name: Dali-Stage Release Pipeline
on:
  push:
    branches:
      - dali-stage
  pull_request:
    branches:
      - dali-stage

env:
  GITHUB_TOKEN: ${{ secrets.COMPOSABLE_GITHUB_TOKEN }}
  RELEASE_VERSION: 
jobs:
  build-and-publish:
    runs-on:
      - self-hosted
      - linux
      - x64
      - sre
    strategy:
      fail-fast: true
    steps:
      - name: Clean up
        continue-on-error: true
        run: |
          sudo chown -R $USER:$USER $GITHUB_WORKSPACE
          docker system prune --force --all --volumes

      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      # This would draft a release note presenting a list of new prs that have been added
      # in between this commit and the previous tag.
      - uses: release-drafter/release-drafter@v5
        id: release_drafter

      - name: Set Permission
        continue-on-error: true
        run: |
          sudo su runner && sudo chmod -R 777  /home/runner/_work/_tool/node/

      - uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: ğŸ”¨ Build Composable Binary
        env:
          # this is so that the binary version corresponds with the release tag.
          RELEASE_VERSION: ${{ steps.release_drafter.outputs.tag_name }}
        run: |
          RELEASE_VERSION=${RELEASE_VERSION:1} make version
          cargo build --release -p composable

      - name: Upload Artifacts
        run: |
          echo "RELEASE_VERSION=$(git tag --sort=committerdate | grep -E '^v[0-9]' | tail -1 )" >> $GITHUB_ENV
          sudo gsutil cp ./target/release/composable gs://composable-binaries/dali-stage/${{ env.RELEASE_VERSION }}/
          
    
  dali-client-release:
    runs-on:
      - self-hosted
      - linux
      - X64
      - ansible-runner
    needs: [build-and-publish]
    steps:
      - name: Clean up
        continue-on-error: true
        run: |
          sudo chown -R $USER:$USER $GITHUB_WORKSPACE
          docker system prune --force --all --volumes
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set env
        run: |
          echo "RELEASE_VERSION=$(git tag --sort=committerdate | grep -E '^v[0-9]' | tail -1 )" >> $GITHUB_ENV
      - name: Run ansible playbook
        working-directory: "./.maintain/playbooks"
        run: |
          ansible-playbook -l _environment_dali_stage dali-stage-client-upgrade.yml -i gcp.yaml  --user runner -e 'ansible_python_interpreter=/usr/bin/python3'
      - name: Notify sre-tasks slack channel
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: releases
          SLACK_USERNAME: Github Actions
          SLACK_ICON: https://avatars.githubusercontent.com/u/44036562?s=200&v=4
          SLACK_TITLE: A new composable client for Dali-rococo ${{ env.RELEASE_VERSION }} has been rolled out
          SLACK_MESSAGE: "https://telemetry.polkadot.io/#list/0x5719ed0c1a5f4a11ef4d206f3a35d350365adc35943f2834b8d5bc7ff6e1a1d2"
          SLACK_FOOTER: ""
          MSG_MINIMAL: true

     
=======
name: "Devnet Staging Internal Release"

on:
  push:
    branches:
      - main

jobs:
  deploy-devnet:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-devnet
      cancel-in-progress: false
    steps:
    - uses: actions/checkout@v2

    - uses: google-github-actions/setup-gcloud@v0
      with:
        service_account_key: ${{ secrets.GCP_CREDENTIALS }}
        export_default_credentials: true

    - uses: actions/setup-python@v2

    - name: Install Nix
      uses: cachix/install-nix-action@v16
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - uses: cachix/cachix-action@v10
      with:
        name: composable-community
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        extraPullNames: composable-community

    - name: Set env
      run: |
        echo "RELEASE_VERSION=$GITHUB_SHA" >> $GITHUB_ENV

    - name: Install Stable
      uses: actions-rs/toolchain@v1
      with:
          toolchain: stable

    - name: Install Nightly
      uses: actions-rs/toolchain@v1
      with:
          toolchain: nightly-2022-02-01
          target: wasm32-unknown-unknown

    - uses: Swatinem/rust-cache@v1

    - name: Build & Push
      run: |
        rustup show
        cargo build --release
        cargo doc --release
        tar -czvf composable-picasso-${{ env.RELEASE_VERSION }}.tar.gz target/release/composable target/doc
        gsutil mv *.tar.gz gs://composable-binaries/community-releases/picasso/
        rm -rf target

    - name: Load state
      run: |
        cd devnet

        ./update.sh $RELEASE_VERSION
        jq --null-input --arg client_email "$GCP_DEVNET_SERVICE_ACCOUNT" --arg project_id "$GCP_PROJECT_ID" --arg key "\"$GCP_DEVNET_SERVICE_ACCOUNT_KEY\"" '{ "project_id": $project_id, "private_key": ($key | fromjson), "client_email": $client_email }' > ops.json

        cd ..

        if gsutil -q stat $NIXOPS_STATE_URL/$NIXOPS_STATE;
        then
          gsutil cp $NIXOPS_STATE_URL/$NIXOPS_STATE $NIXOPS_STATE
        else
          nix develop .#devnet-stage --command nixops create -d devnet-gce
        fi
      env:
        NIXOPS_STATE_URL: "gs://composable-state"
        NIXOPS_STATE: "deployment.nixops"
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        GCP_DEVNET_SERVICE_ACCOUNT: ${{ secrets.GCP_DEVNET_SERVICE_ACCOUNT }}
        GCP_DEVNET_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_DEVNET_SERVICE_ACCOUNT_KEY }}

    - name: Deploy
      run: |
        nix develop .#devnet-stage --command nixops deploy --check --confirm -d devnet-gce
      env:
        NIXOPS_STATE: "deployment.nixops"

    - name: Store state
      if: always()
      run: |
        gsutil cp $NIXOPS_STATE $NIXOPS_STATE_URL/
      env:
        NIXOPS_STATE: "deployment.nixops"
        NIXOPS_STATE_URL: "gs://composable-state"
>>>>>>> 81a0843a (Setup stage environment for devnet)
