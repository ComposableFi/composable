name: CI Check

# please update docker, toolchain toml and github action with toolchain at same time

on:
  push:
    paths-ignore:
      - frontend/**
    branches:
      - main
      # bors related branches. Please do not remove.
      - staging
      - trying
  pull_request:
    paths-ignore:
      - frontend/**
    branches:
      - main
      - develop
      - releases

  workflow_dispatch:

env:
  DOCKER_USER_OPTION: "$UID:$GID"

jobs:

  linters:
    name: Linters
    runs-on:
      - self-hosted
      - linux
      - x64
      - sre
    concurrency:
      group: ${{ github.workflow}}-lint-${{ github.ref }}
      cancel-in-progress: true
    container:
      image: composablefi/ci-linux:2022-08-06
    steps:
      - uses: actions/checkout@v2
      - name: Rustup show
        run: |
          rustup show
      - name: Use Node.js 14.x
        uses: actions/setup-node@v2
        with:
          node-version: 14.x

      - name: Work around permission issue (https://github.com/actions/checkout/issues/760)
        run: |
          git config --global --add safe.directory /__w/composable/composable

      - name: mdbook
        run: |
          set -e
          cd book
          mdbook test 2>&1 | tee log
          if [ -z "$(cat log | grep ERROR)" ]; then
            true
          else
            exit 1
          fi
