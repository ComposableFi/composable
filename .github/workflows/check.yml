name: Test & Build & Benchmarking Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-build:
    runs-on: 
      - self-hosted
      - linux
      - x64
      - sre
    container: 
      image: rust
    steps:
      - uses: actions/checkout@v2
      - name: Cache
        uses: actions-rs/toolchain@v1
        with: 
          profile: minimal
          toolchain: stable
      - name: Clean project artifacts
        # uses: Swatinem/rust-cache@v1
        run: |
          cargo clean -p picasso-runtime
          cargo clean -p composable
      - name: Cargo test
        run: |
          cargo test
      - name: Cargo check
        run: |
          SKIP_WASM_BUILD=1 cargo check --release
      - name: Check build for benchmarking
        run: >
          pushd node &&
          cargo check --features=runtime-benchmarks --release
