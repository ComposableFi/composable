name: Deploy Persistent Devnet

on: push
  # workflow_dispatch:
  #   inputs:
  #     ref:
  #       description: "The commit has or branch or tag you want to deploy a persistent devnet for."
  #       required: true
  #       type: string

env:
  CACHIX_COMPOSABLE: composable-community
  CACHIX_COMPRESSION_LEVEL: 3

jobs:
  deploy-devnet:
      name: "Deploy Persistent Devnet"
      runs-on: ubuntu-latest
      concurrency:
        group: nix-deploy-devnet
        cancel-in-progress: false
      steps:
      - uses: actions/checkout@v3
        with:
          # ref: ${{ inputs.revision }}
          fetch-depth: 0
      - uses: cachix/install-nix-action@v17
        with:
          extra_nix_config: |
            sandbox = relaxed
            narinfo-cache-negative-ttl = 0
      - uses: cachix/cachix-action@f5f67badd061acb62b5c6e25e763572ca8317004
        with:
          skipPush: true
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ${{  env.CACHIX_COMPOSABLE }}

      - uses: google-github-actions/setup-gcloud@v0.6.0
        with:
          service_account_key: ${{ secrets.GCP_CREDENTIALS }}
          export_default_credentials: true
          credentials_file_path: ${{ runner.temp }}/credentials

      - name: Build & Push
        run: |
          if gsutil -q stat $NIXOPS_STATE_URL/$NIXOPS_STATE_FILE;
          then
            gsutil cp $NIXOPS_STATE_URL/$NIXOPS_STATE_FILE $NIXOPS_STATE
          else
            nix develop .#ci --show-trace -L --command cachix watch-exec --jobs 16 --compression-level $CACHIX_COMPRESSION_LEVEL composable-community nixops -- create --deployment devnet-gce --show-trace --option narinfo-cache-negative-ttl 0
            gsutil cp $NIXOPS_STATE $NIXOPS_STATE_URL/
          fi

          git status
          nix develop .#ci --show-trace -L --command cachix watch-exec --jobs 16 --compression-level $CACHIX_COMPRESSION_LEVEL composable-community nixops -- deploy --check --confirm --deployment devnet-gce --debug --show-trace --option narinfo-cache-negative-ttl 0 --include composable-persistent-devnet

          gsutil cp $NIXOPS_STATE $NIXOPS_STATE_URL/$NIXOPS_STATE_FILE

        env:
          NIXOPS_STATE: ${{ runner.temp }}/deployment.nixops
          NIXOPS_STATE_URL: gs://composable-state
          NIXOPS_STATE_FILE: deployment.nixops
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_DEVNET_SERVICE_ACCOUNT: ${{ secrets.GCP_DEVNET_SERVICE_ACCOUNT }}
          GCP_DEVNET_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_DEVNET_SERVICE_ACCOUNT_KEY }}
