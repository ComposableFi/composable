name: GCS Bucket deploy 
on:
  push: 
    branches: 
      - main
      - setup-cicd-for-mdbook

env:
  CI_SERVICE_ACCOUNT_KEY: ${{ secrets.CI_SERVICE_ACCOUNT_KEY }}

jobs:
  build-and-deploy-book:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      
      - uses: actions/setup-node@v1
        with:
          node-version: '16.x'

      - name: Setup mdBook
        run: |
          wget "https://github.com/rust-lang/mdBook/releases/download/v0.4.18/mdbook-v0.4.18-x86_64-unknown-linux-gnu.tar.gz" 
          tar -xzf mdbook-v0.4.18-x86_64-unknown-linux-gnu.tar.gz 
          chmod +x mdbook
          sudo cp ./mdbook /usr/bin 

      - name: Upload to Bucket
        working-directory: 'book'
        run: |
          mdbook build --dest-dir html/
          

      - name: 'upload-folder'
        uses: 'google-github-actions/upload-cloud-storage@v0'
        with:
          path: 'book/html/'
          destination: 'docs.composable.finance'

      - name: Deploy to CLoud Storage Website
        uses: abinmn/gcp-storage-bucket-action@v1.0
        with:
          service_key: ${{ secrets.CI_SERVICE_ACCOUNT_KEY }}
          project: "composable-ci"
          home_page_path: "/"
          error_page_path: # Path of the 404 page to be shown
          build_folder: "/"
