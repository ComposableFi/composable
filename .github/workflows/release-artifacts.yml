name: Nix Release Pipeline
on:
  push:
    branches:
      - release-*
      - nix-releaZe-workflow

env:
  GITHUB_TOKEN: ${{ secrets.COMPOSABLE_GITHUB_TOKEN }}
  NIX_NIXPKGS_CHANNEL: https://nixos.org/channels/nixpkgs-22.05-darwin
  CACHIX_COMPOSABLE: composable-community
  CACHIX_COMPRESSION_LEVEL: 4
  DOCKER_REGISTRY_NAME: composablefi
  DOCKER_USER_OPTION: '$UID:$GID'

jobs:
  build-runtime:
    name: "Build WASM runtime"
    runs-on:
      - self-hosted
      - linux
      - x64
      - sre
    concurrency:
      group: build-runtime-${{ matrix.runtime }}-${{ github.ref }}
      cancel-in-progress: true
    container:
      image: niteo/nixpkgs-nixos-22.05:316b762afdb9e142a803f29c49a88b4a47db80ee
    strategy:
      matrix:
        runtime: [dali, picasso, composable]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup nix configuration
        run: |
          echo "experimental-features = nix-command flakes" > /etc/nix/nix.conf
          echo "sandbox = relaxed" >> /etc/nix/nix.conf
          echo "narinfo-cache-negative-ttl = 0" >> /etc/nix/nix.conf

      - name: Setup cachix
        uses: cachix/cachix-action@f5f67badd061acb62b5c6e25e763572ca8317004
        with:
          skipPush: true
          installCommand: |
            nix-channel --add ${{env.NIX_NIXPKGS_CHANNEL }} nixpkgs
            nix-channel --update
            nix-env -iA nixpkgs.cachix
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: composable-community

      - name: Build runtime
        run: |
          cachix watch-exec --compression-level $CACHIX_COMPRESSION_LEVEL $CACHIX_COMPOSABLE nix -- build .#${{ matrix.runtime }}-runtime

  build-composable-node:
    name: "Build Composable node (runtimeless)"
    runs-on:
      - self-hosted
      - linux
      - x64
      - sre
    concurrency:
      group: build-composable-node-${{ github.ref }}
      cancel-in-progress: true
    container:
      image: niteo/nixpkgs-nixos-22.05:316b762afdb9e142a803f29c49a88b4a47db80ee
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup nix configuration
        run: |
          echo "experimental-features = nix-command flakes" > /etc/nix/nix.conf
          echo "sandbox = relaxed" >> /etc/nix/nix.conf
          echo "narinfo-cache-negative-ttl = 0" >> /etc/nix/nix.conf

      - name: Setup cachix
        uses: cachix/cachix-action@f5f67badd061acb62b5c6e25e763572ca8317004
        with:
          skipPush: true
          installCommand: |
            nix-channel --add ${{env.NIX_NIXPKGS_CHANNEL }} nixpkgs
            nix-channel --update
            nix-env -iA nixpkgs.cachix
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: composable-community

      - name: Build Composable node (without runtime)
        run: |
          cachix watch-exec --compression-level $CACHIX_COMPRESSION_LEVEL $CACHIX_COMPOSABLE nix -- build .#composable-node-release

  release:
    name: "Prepare for release"
    runs-on:
      - self-hosted
      - linux
      - x64
      - sre
    needs:
      - build-runtime
      - build-composable-node
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: true
    container:
      image: niteo/nixpkgs-nixos-22.05:316b762afdb9e142a803f29c49a88b4a47db80ee
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup nix configuration
        run: |
          echo "experimental-features = nix-command flakes" > /etc/nix/nix.conf
          echo "sandbox = relaxed" >> /etc/nix/nix.conf
          echo "narinfo-cache-negative-ttl = 0" >> /etc/nix/nix.conf

      - name: Setup cachix
        uses: cachix/cachix-action@f5f67badd061acb62b5c6e25e763572ca8317004
        with:
          skipPush: true
          installCommand: |
            nix-channel --add ${{env.NIX_NIXPKGS_CHANNEL }} nixpkgs
            nix-channel --update
            nix-env -iA nixpkgs.cachix
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: composable-community

      - name: Install docker
        run: nix-env -iA nixpkgs.docker

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}  

      - name: Download artifacts
        run: |
          nix bundle --bundler github:NixOS/bundlers#toDockerImage .#composable-node-release -L --out-link composable-docker-image
          nix bundle --bundler github:NixOS/bundlers#toRPM .#composable-node-release -L --out-link rpm
          nix bundle --bundler github:NixOS/bundlers#toDEB .#composable-node-release -L --out-link deb

          nix build .#dali-runtime --out-link dali-runtime
          nix build .#picasso-runtime --out-link picasso-runtime
          nix build .#composable-runtime --out-link composable-runtime

      - name: Setup release drafter
        uses: release-drafter/release-drafter@v5

      - name: Release docker image
        run: |
          docker load --input ./composable-docker-image
          docker tag composable:$(nix eval --raw .#composable-node-release.version) "${{ env.DOCKER_REGISTRY_NAME }}/composable-sandbox:$(nix eval --raw .#composable-node-release.version)"
          docker push "${{ env.DOCKER_REGISTRY_NAME }}/composable-sandbox:$(nix eval --raw .#composable-node-release.version)"

      - name: Release artifacts
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          fail_on_unmatched_files: true
          files: |
            rpm/*.rpm
            deb/*.deb
            dali-runtime/lib/*.wasm
            picasso-runtime/lib/*.wasm
            composable-runtime/lib/*.wasm
